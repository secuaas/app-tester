// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============== USERS ==============

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String   // bcrypt hashed
  role      UserRole @default(USER)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  apiKeys ApiKey[]

  @@map("users")
}

enum UserRole {
  ADMIN
  USER
  VIEWER
}

model ApiKey {
  id          String    @id @default(cuid())
  name        String
  keyHash     String    @unique
  prefix      String    // First 12 chars for identification
  permissions String[]
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  userId      String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("api_keys")
}

// ============== APPLICATIONS ==============

model Application {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  type        AppType
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  environments Environment[]
  testSuites   TestSuite[]
  credentials  Credential[]

  @@map("applications")
}

enum AppType {
  API
  WEB
  HYBRID
}

model Environment {
  id            String   @id @default(cuid())
  name          String   // dev, staging, prod
  baseUrl       String
  isActive      Boolean  @default(true)
  applicationId String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  application Application     @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  executions  Execution[]
  schedules   TestSchedule[]

  @@unique([applicationId, name])
  @@map("environments")
}

// ============== TESTS ==============

model TestSuite {
  id            String   @id @default(cuid())
  name          String
  description   String?
  type          TestType @default(API)
  timeout       Int      @default(300) // seconds
  tags          String[] @default([])
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  applicationId String
  credentialId  String?  // Default credential to use

  application Application    @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  steps       TestStep[]
  executions  Execution[]
  schedules   TestSchedule[]

  @@unique([applicationId, name])
  @@map("test_suites")
}

enum TestType {
  API
  E2E
}

model TestStep {
  id               String   @id @default(cuid())
  name             String
  description      String?
  order            Int
  endpoint         String
  method           HttpMethod
  headers          Json?             // Record<string, string>
  body             Json?             // any
  assertions       Json              @default("[]") // Assertion[]
  extractVariables Json              @default("[]") // VariableExtractor[]
  timeout          Int?              // Override suite timeout
  continueOnError  Boolean           @default(false)
  testSuiteId      String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  testSuite   TestSuite    @relation(fields: [testSuiteId], references: [id], onDelete: Cascade)
  stepResults StepResult[]

  @@map("test_steps")
}

enum HttpMethod {
  GET
  POST
  PUT
  PATCH
  DELETE
  HEAD
  OPTIONS
}

// ============== EXECUTIONS ==============

model Execution {
  id            String          @id @default(cuid())
  status        ExecutionStatus
  startedAt     DateTime        @default(now())
  completedAt   DateTime?
  duration      Int?            // milliseconds
  triggeredBy   String          @default("manual") // user ID or "api" or "scheduler" or "claude"
  variables     Json?           // Runtime variables
  summary       Json?           // { total, passed, failed, skipped }
  testSuiteId   String
  environmentId String
  credentialId  String?

  testSuite   TestSuite    @relation(fields: [testSuiteId], references: [id])
  environment Environment  @relation(fields: [environmentId], references: [id])
  credential  Credential?  @relation(fields: [credentialId], references: [id])
  stepResults StepResult[]
  artifacts   Artifact[]

  @@index([status])
  @@index([startedAt])
  @@index([testSuiteId])
  @@map("executions")
}

enum ExecutionStatus {
  PENDING
  RUNNING
  PASSED
  FAILED
  ERROR
}

model StepResult {
  id                String          @id @default(cuid())
  status            ExecutionStatus
  startedAt         DateTime
  completedAt       DateTime
  duration          Int             // milliseconds
  request           Json?           // { method, url, headers, body }
  response          Json?           // { status, headers, body, time }
  assertions        Json            @default("[]") // AssertionResult[]
  extractedVariables Json           @default("{}") // Record<string, any>
  error             String?
  executionId       String
  testStepId        String

  execution Execution @relation(fields: [executionId], references: [id], onDelete: Cascade)
  testStep  TestStep  @relation(fields: [testStepId], references: [id])

  @@map("step_results")
}

model Artifact {
  id          String       @id @default(cuid())
  type        ArtifactType
  name        String
  path        String       // S3/MinIO path
  size        Int          // bytes
  mimeType    String
  createdAt   DateTime     @default(now())
  executionId String

  execution Execution @relation(fields: [executionId], references: [id], onDelete: Cascade)

  @@map("artifacts")
}

enum ArtifactType {
  SCREENSHOT
  REPORT_HTML
  REPORT_PDF
  REPORT_JSON
  LOG
}

// ============== CREDENTIALS ==============

model Credential {
  id            String         @id @default(cuid())
  name          String
  type          CredentialType
  encryptedData Bytes          // AES-256-GCM encrypted
  iv            Bytes          // Initialization vector (12 bytes)
  authTag       Bytes          // Authentication tag (16 bytes)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  applicationId String

  application Application  @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  executions  Execution[]

  @@unique([applicationId, name])
  @@map("credentials")
}

enum CredentialType {
  API_KEY
  BASIC_AUTH
  BEARER_TOKEN
  OAUTH2
  CUSTOM_HEADERS
}

// ============== AUDIT ==============

model AuditLog {
  id         String   @id @default(cuid())
  action     String
  entityType String
  entityId   String
  userId     String?
  ipAddress  String?
  userAgent  String?
  details    Json?
  createdAt  DateTime @default(now())

  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============== SCHEDULING ==============

model TestSchedule {
  id             String   @id @default(cuid())
  testId         String
  environmentId  String
  cronExpression String   // Cron format: "0 0 * * *"
  isActive       Boolean  @default(true)
  lastRunAt      DateTime?
  nextRunAt      DateTime?
  errorCount     Int      @default(0)
  lastError      String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  test        TestSuite   @relation(fields: [testId], references: [id], onDelete: Cascade)
  environment Environment @relation(fields: [environmentId], references: [id], onDelete: Cascade)

  @@map("test_schedules")
}

// ============== WEBHOOKS ==============

model Webhook {
  id        String   @id @default(cuid())
  name      String
  url       String
  events    String[] // Array of event names
  secret    String   // HMAC secret for signature
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  logs WebhookLog[]

  @@map("webhooks")
}

model WebhookLog {
  id              String   @id @default(cuid())
  webhookId       String
  event           String
  status          String   // SUCCESS, FAILED
  statusCode      Int?
  requestPayload  Json
  responseBody    Json?
  error           String?
  createdAt       DateTime @default(now())

  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId, createdAt])
  @@map("webhook_logs")
}
